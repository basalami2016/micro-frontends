import React, { useState } from 'react';
import '../App.css';

interface Vulnerability {
  id: string;
  cve: string;
  severity: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW';
  package: string;
  version: string;
  fixedVersion: string;
  description: string;
  cvssScore: number;
  publishedDate: string;
  affectedPaths: string[];
}

// Simulated vulnerability data from OSV scanner
const mockVulnerabilities: Vulnerability[] = [
  {
    id: 'GHSA-jfh8-c2jp-5v3q',
    cve: 'CVE-2023-45857',
    severity: 'CRITICAL',
    package: 'axios',
    version: '0.21.1',
    fixedVersion: '1.6.0',
    description: 'Axios Cross-Site Request Forgery Vulnerability - Improper handling of XSRF tokens allows attackers to bypass CSRF protection',
    cvssScore: 9.8,
    publishedDate: '2023-11-08',
    affectedPaths: [
      'node_modules/axios',
      'package-lock.json'
    ]
  },
  {
    id: 'GHSA-wf5p-g6vw-rhxx',
    cve: 'CVE-2023-26136',
    severity: 'HIGH',
    package: 'tough-cookie',
    version: '4.0.0',
    fixedVersion: '4.1.3',
    description: 'Prototype Pollution in tough-cookie - Attackers can manipulate cookie parsing leading to potential RCE',
    cvssScore: 7.5,
    publishedDate: '2023-07-01',
    affectedPaths: [
      'node_modules/tough-cookie',
      'node_modules/request/node_modules/tough-cookie'
    ]
  },
  {
    id: 'GHSA-f8q6-p94x-37v3',
    cve: 'CVE-2023-26115',
    severity: 'HIGH',
    package: 'word-wrap',
    version: '1.2.3',
    fixedVersion: '1.2.4',
    description: 'ReDoS vulnerability in word-wrap - Regular expression denial of service in word wrapping function',
    cvssScore: 7.5,
    publishedDate: '2023-06-22',
    affectedPaths: [
      'node_modules/word-wrap'
    ]
  },
  {
    id: 'GHSA-78xj-cgh5-2h22',
    cve: 'CVE-2023-44270',
    severity: 'MEDIUM',
    package: 'postcss',
    version: '8.4.20',
    fixedVersion: '8.4.31',
    description: 'PostCSS line return parsing error - Improper handling of line returns can lead to XSS in certain configurations',
    cvssScore: 5.3,
    publishedDate: '2023-09-29',
    affectedPaths: [
      'node_modules/postcss'
    ]
  },
  {
    id: 'GHSA-c2qf-rxjj-qqgw',
    cve: 'CVE-2023-26118',
    severity: 'MEDIUM',
    package: 'semver',
    version: '7.3.5',
    fixedVersion: '7.5.2',
    description: 'Regular Expression Denial of Service in semver - Inefficient regular expression complexity in version parsing',
    cvssScore: 5.3,
    publishedDate: '2023-06-21',
    affectedPaths: [
      'node_modules/semver'
    ]
  },
  {
    id: 'GHSA-3xgq-45jj-v275',
    cve: 'CVE-2023-39331',
    severity: 'LOW',
    package: 'nodemon',
    version: '2.0.20',
    fixedVersion: '3.0.1',
    description: 'Command injection vulnerability in nodemon - Local users can inject commands through configuration files',
    cvssScore: 3.3,
    publishedDate: '2023-08-30',
    affectedPaths: [
      'node_modules/nodemon'
    ]
  }
];

const VulnerabilityPage: React.FC = () => {
  const [selectedVuln, setSelectedVuln] = useState<Vulnerability | null>(null);
  const [filterSeverity, setFilterSeverity] = useState<string>('ALL');

  const filteredVulnerabilities = filterSeverity === 'ALL'
    ? mockVulnerabilities
    : mockVulnerabilities.filter(v => v.severity === filterSeverity);

  const severityCounts = {
    CRITICAL: mockVulnerabilities.filter(v => v.severity === 'CRITICAL').length,
    HIGH: mockVulnerabilities.filter(v => v.severity === 'HIGH').length,
    MEDIUM: mockVulnerabilities.filter(v => v.severity === 'MEDIUM').length,
    LOW: mockVulnerabilities.filter(v => v.severity === 'LOW').length,
  };

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'CRITICAL': return '#dc2626';
      case 'HIGH': return '#ea580c';
      case 'MEDIUM': return '#f59e0b';
      case 'LOW': return '#3b82f6';
      default: return '#6b7280';
    }
  };

  return (
    <div className="vulnerability-container">
      <header className="vulnerability-header">
        <div>
          <h1>ğŸ›¡ï¸ Software Supply Chain Security</h1>
          <p>OSV Scanner Vulnerability Report</p>
        </div>
        <div className="scan-info">
          <span className="scan-badge">Last Scan: 2 hours ago</span>
          <button className="btn-scan">ğŸ” Run New Scan</button>
        </div>
      </header>

      {/* Summary Stats */}
      <div className="vuln-stats">
        <div className="stat-card critical">
          <div className="stat-number">{severityCounts.CRITICAL}</div>
          <div className="stat-label">Critical</div>
        </div>
        <div className="stat-card high">
          <div className="stat-number">{severityCounts.HIGH}</div>
          <div className="stat-label">High</div>
        </div>
        <div className="stat-card medium">
          <div className="stat-number">{severityCounts.MEDIUM}</div>
          <div className="stat-label">Medium</div>
        </div>
        <div className="stat-card low">
          <div className="stat-number">{severityCounts.LOW}</div>
          <div className="stat-label">Low</div>
        </div>
        <div className="stat-card total">
          <div className="stat-number">{mockVulnerabilities.length}</div>
          <div className="stat-label">Total Issues</div>
        </div>
      </div>

      {/* Filter Bar */}
      <div className="filter-bar">
        <div className="filter-group">
          <label>Filter by Severity:</label>
          <select 
            value={filterSeverity} 
            onChange={(e) => setFilterSeverity(e.target.value)}
            className="filter-select"
          >
            <option value="ALL">All Severities</option>
            <option value="CRITICAL">Critical Only</option>
            <option value="HIGH">High Only</option>
            <option value="MEDIUM">Medium Only</option>
            <option value="LOW">Low Only</option>
          </select>
        </div>
        <div className="result-count">
          Showing {filteredVulnerabilities.length} vulnerabilities
        </div>
      </div>

      {/* Main Content Grid */}
      <div className="vuln-content-grid">
        {/* Vulnerability List */}
        <div className="vuln-list">
          {filteredVulnerabilities.map((vuln) => (
            <div 
              key={vuln.id}
              className={`vuln-card ${selectedVuln?.id === vuln.id ? 'selected' : ''}`}
              onClick={() => setSelectedVuln(vuln)}
            >
              <div className="vuln-card-header">
                <span 
                  className="severity-badge"
                  style={{ backgroundColor: getSeverityColor(vuln.severity) }}
                >
                  {vuln.severity}
                </span>
                <span className="cvss-score">CVSS: {vuln.cvssScore}</span>
              </div>
              
              <h3 className="vuln-title">{vuln.cve}</h3>
              
              <div className="vuln-package-info">
                <div className="package-name">ğŸ“¦ {vuln.package}</div>
                <div className="version-info">
                  <span className="current-version">{vuln.version}</span>
                  <span className="arrow">â†’</span>
                  <span className="fixed-version">{vuln.fixedVersion}</span>
                </div>
              </div>
              
              <p className="vuln-description">{vuln.description.substring(0, 100)}...</p>
            </div>
          ))}
        </div>

        {/* Details Panel */}
        <div className="vuln-details-panel">
          {selectedVuln ? (
            <>
              <div className="details-header">
                <h2>Vulnerability Details</h2>
                <span 
                  className="severity-badge large"
                  style={{ backgroundColor: getSeverityColor(selectedVuln.severity) }}
                >
                  {selectedVuln.severity}
                </span>
              </div>

              <div className="details-section">
                <h3>ğŸ” Identification</h3>
                <div className="details-grid">
                  <div className="detail-item">
                    <label>CVE ID:</label>
                    <span>{selectedVuln.cve}</span>
                  </div>
                  <div className="detail-item">
                    <label>Advisory ID:</label>
                    <span>{selectedVuln.id}</span>
                  </div>
                  <div className="detail-item">
                    <label>CVSS Score:</label>
                    <span className="cvss-large">{selectedVuln.cvssScore}</span>
                  </div>
                  <div className="detail-item">
                    <label>Published:</label>
                    <span>{selectedVuln.publishedDate}</span>
                  </div>
                </div>
              </div>

              <div className="details-section">
                <h3>ğŸ“¦ Package Information</h3>
                <div className="details-grid">
                  <div className="detail-item">
                    <label>Package Name:</label>
                    <span>{selectedVuln.package}</span>
                  </div>
                  <div className="detail-item">
                    <label>Vulnerable Version:</label>
                    <span className="version-vulnerable">{selectedVuln.version}</span>
                  </div>
                  <div className="detail-item">
                    <label>Fixed Version:</label>
                    <span className="version-fixed">{selectedVuln.fixedVersion}</span>
                  </div>
                </div>
              </div>

              <div className="details-section">
                <h3>ğŸ“ Description</h3>
                <p className="full-description">{selectedVuln.description}</p>
              </div>

              <div className="details-section">
                <h3>ğŸ“‚ Affected Paths</h3>
                <ul className="affected-paths">
                  {selectedVuln.affectedPaths.map((path, idx) => (
                    <li key={idx}>
                      <code>{path}</code>
                    </li>
                  ))}
                </ul>
              </div>

              <div className="details-section">
                <h3>ğŸ”§ Remediation</h3>
                <div className="remediation-box">
                  <p>Update the package to the fixed version:</p>
                  <code className="command-box">
                    npm install {selectedVuln.package}@{selectedVuln.fixedVersion}
                  </code>
                  <p className="remediation-note">
                    âš ï¸ Test thoroughly after updating to ensure compatibility
                  </p>
                </div>
              </div>

              <div className="action-buttons">
                <button className="btn-primary">ğŸ”„ Auto-Fix</button>
                <button className="btn-secondary">ğŸ“‹ Export Report</button>
                <button className="btn-secondary">ğŸ”— View on GitHub</button>
              </div>
            </>
          ) : (
            <div className="details-placeholder">
              <div className="placeholder-icon">ğŸ”</div>
              <h3>Select a Vulnerability</h3>
              <p>Click on any vulnerability from the list to view detailed information</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default VulnerabilityPage;
